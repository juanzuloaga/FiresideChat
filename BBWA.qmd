---
title: "BBWA (Bay-breasted Warbler): Region BCR-71"
format:
  html:
    self-contained: true
    link-external-icon: true
    link-external-newwindow: true
    hide:
      - toc
      - navigation
editor: visual
css: styles.css
---

Use THIS FORM [BBWA-BCR-71](https://docs.google.com/forms/d/1xhekH7fj2461LX_AAbN8Md1mLibKmaGo4mF_FexQm3M/edit) to provide your feedback on each section of the model cycle.

```{r echo=F, message=F, warning=FALSE}
# Setting working directory
setwd("C:/FiresideChat")
# Libraries
library(dplyr)
library(reshape2)
library(tidyr)
library(kableExtra)
library(sf)
library(terra)
library(tidyterra)
library(tibble)
library(ggplot2)
library(leaflet)
library(DT)
library(gbm)
library(wrapr)
library(reactable)
library(lubridate)
library(openxlsx)
library(shiny)
library(widgetframe)
library(leafem)
library(tidyverse)

# Setting working directory
setwd("C:/FiresideChat/")

```

```{r echo=FALSE, warning=FALSE, message=FALSE}
# TASK 1. HISTOGRAM COUNTS
#Loading master file and selecting ecoregions c71 & c81
load("./data/04_NM5.0_data_stratify_7181.R")

# Selecting BCRs 71 and 81 that are TRUE
bcrlist_can71 <- dplyr::select(bcrlist, id, can71)%>%
dplyr::filter(can71 == "TRUE")

bcrlist_can81 <- dplyr::select(bcrlist, id, can81)%>%
dplyr::filter(can81 == "TRUE")

#Transofrm bird objec from matrix to df
bird_d <- as.data.frame(as.matrix(bird))
names(bird_d)[1] <- "id"

# Merging bcrlist_sel and bird_d by id, indicate if species was detected or not
birds_merged_can71 <- merge(bcrlist_can71, bird_d, by="id")%>%
   subset(select = c("id",  "BBWA")) |> 
    mutate(BBWA=as.numeric(BBWA),
           detection = ifelse(BBWA > 0, 1, 0)) |> 
  rename(count = BBWA)
  
birds_merged_can81 <- merge(bcrlist_can81, bird_d, by="id")%>%
   subset(select = c("id", "BBWA")) |> 
    mutate(BBWA=as.numeric(BBWA),
           detection = ifelse(BBWA > 0, 1, 0)) |> 
  rename(count = BBWA)

# TASK 2. TEMPORAL DISTRIBUTION OF DETECTIONS
# adding the DATE, TIME, and COORDS
visit_detections_can71 <- merge(bcrlist_can71, visit, by="id")%>%
  inner_join(birds_merged_can71) |> 
   subset(select = c("id", "tssr", "jday", "count", "detection", "lat", "lon")) |> 
  pivot_longer(c(jday, tssr), names_to="metric", values_to="value") |> 
  mutate(metric = factor(metric, levels = c("tssr", "jday"),
                            labels = c("Time since sunrise", "Ordinal day")),
         detection = factor(detection, levels=c(0, 1), labels = c("Undetected", "Detected")))

visit_detections_can81 <- merge(bcrlist_can81, visit, by="id")%>%
    inner_join(birds_merged_can71) |> 
   subset(select = c("id", "tssr", "jday", "count", "detection", "lat", "lon")) |> 
  pivot_longer(c(jday, tssr), names_to="metric", values_to="value") |> 
  mutate(metric = factor(metric, levels = c("tssr", "jday"),
                            labels = c("Time since sunrise", "Ordinal day")),
         detection = factor(detection, levels=c(0, 1), labels = c("Undetected", "Detected")))

```

```{r echo=FALSE}

# Boundaries regions
bcr_boundary <- terra::vect("./data/BAM_BCR_NationalModel.shp")

# Boundary geographic for interactive leaflet
bcr_boundary_wgs84 <- terra::project(bcr_boundary, "epsg:4326")

# raster stack
BBWA_can71_2020 <- terra::rast("./data/BBWA/BBWA_can71_2020.tiff")
BBWA_can81_2020 <- terra::rast("./data/BBWA/BBWA_can81_2020.tiff")


```

::: panel-tabset
## 1. SPECIES

::: {.callout-note collapse="true"}
## a. Histogram of counts

::: {style="display: flex;"}
<div>

**Task:**

We would like to know if there are outliers and/or a truncation value that modelers might be aware of.

</div>

<div>

**Description:**

This is an histogram of raw count from data sets included in the model.

```{r echo=FALSE, message=FALSE, warning=FALSE}

# Histogram

ggplot(dplyr::filter(birds_merged_can71, count > 0), aes(x=count))+
  geom_histogram()+
  labs(x="Count of birds observed", y = "Number of surveys with detections")+
  theme(axis.text=element_text(size=14))+
  theme(axis.title = element_text(size = 16))
 
```

</div>
:::
:::

::: {.callout-note collapse="true"}
## b. Temporal distribution of detections (time relative to sunrise, ordinal day)

::: {style="display: flex;"}
<div>

**Task:**

We would like to know if there are outliers and/or a truncation value that modelers might be aware of.

</div>

<div>

**Description:**

This is the temporal distribution of detections.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Histogram

ggplot(visit_detections_can71, aes(x=value))+
  geom_histogram()+
  labs(x="", y = "Number of surveys")+
  facet_grid(detection~metric, scales="free") +
  theme(axis.text=element_text(size=14))+
  theme(axis.title = element_text(size = 16))


 
```

</div>
:::
:::

::: {.callout-note collapse="true"}
## c. Training data

::: {style="display: flex;"}
<div>

**Task:**

Please identify misidentifications, migratory individuals, or surprises

</div>

<div>

**Description:**

Please use the map below to visualize species data

```{r echo=FALSE}

locations_can71 <- st_as_sf(visit_detections_can71, coords=c("lon", "lat"), crs=4326) |> 
  terra::vect() |> 
  terra::project(crs(bcr_boundary))

locations_can81 <- st_as_sf(visit_detections_can81, coords=c("lon", "lat"), crs=4326) |> 
  terra::vect() |> 
  terra::project(crs(bcr_boundary))


```

</div>
:::
:::

## 2. COVARIATES

```{r echo=FALSE, message=FALSE, warning=FALSE}
#covlist <- read.csv("./data/covlist.csv")
#covlist_sel <- read.csv("./covlist_sel.csv")

covlist_sel <- dplyr::filter(covlist, bcr %in% c("can71", "can81"))%>%
  dplyr::select(where(~ last(.x) != "FALSE"))%>%
  reshape2::melt(id.vars =  "bcr")
 names(covlist_sel)[2] <- "Covariate.label"

cov_label <- read.xlsx("./data/covariates_label_insert.xlsx")

merge_cov <- merge(covlist_sel, cov_label, by="Covariate.label")
cov_bcr71 <- filter(merge_cov, bcr == "can71")%>%
  dplyr::select(Covariate.label, Category, Description)
cov_bcr81 <- filter(merge_cov, bcr == "can81")

```

::: {.callout-note collapse="true"}
## a. Covariates relative importance

**Task:** Please re-rank covariates and/or suggest expected relative importance and/or percentage (%).

**Description:** Covariates relative importance (mean 10 bootstraps)

```{r echo=FALSE, warning=FALSE, message=FALSE}

list_bootstraps <- list.files("./data/BBWA/covariates_bootstrps/can_71",
                             pattern=".R",
                             full.names = T)

df_bootstrap <- do.call(rbind,
               lapply(list_bootstraps, function(x) {
                 
                 load(file = x)
                 gbm::summary.gbm(b.i, plotit = F)
               }))

df_bootstrap_mean <- dplyr::summarise(df_bootstrap, .by=var, mean=mean(rel.inf))

df_bootstrap_sd <- dplyr::summarise(df_bootstrap, .by=var, sd=sd(rel.inf))

n = length(df_bootstrap$rel.inf)

df_bootstrap_sd$se <- df_bootstrap_sd$sd / sqrt(n)

df_bootstrap_merge <- merge(df_bootstrap_mean, df_bootstrap_sd, by="var")

```

```{r echo=FALSE, fig.height=6}

ggplot(data=df_bootstrap_merge, aes(x=reorder(var, mean), y=mean, fill=mean))+
           geom_bar(stat = "identity", fill="gray") + 
   labs(title = "Covariates relative importance",
        x = "Covariates", y = "%")+
  coord_flip()+
    theme(legend.position = "none")+
  geom_errorbar(
    aes(ymin = mean - se, ymax = mean + se), 
    position = position_dodge2(padding = 0.5))
```
:::

::: {.callout-note collapse="true"}
## b. Covariates list and description

**Task:** Task: Please suggest adding/removing covariates from the list.

**Description:** List of covariates used in model fitting

```{r echo=FALSE}


cov_table <- htmltools::tagList(DT::datatable(cov_bcr71, filter='top',  rownames = F, escape = F), options = list(
  pageLength = 5, autoWidth = TRUE
))



```
:::

```{r}
cov_table
```

## 3. DATA PREPARATION

3.1. Species

3.2. Covariates

Coming soon!

## 4. MODEL FITTING

Coming soon!

## 5. PREDICTIONS

::: {.callout-note collapse="true"}
## a. Mean density map

**Task:**

Please identify areas that are too high or too low density, if any.

**Description:**

This map below shows estimates predicitons (PREDICTION layer) of the number of males per hectare ???????
:::

## 6. UNCERTAINTY

::: {.callout-note collapse="true"}
## a. Coefficient of variation

**Task:**

Please identify any areas that are surprising for you.

**Description:**

Use the map below to visualize the UNCERTAINTY layer (i.e., the coefficient of variation 'CV' of 10 models). Areas with low Uncertainty will display high CV values.
:::

::: {.callout-note collapse="true"}
## b. Extrapolation map

**Task:**

Please identify any areas that are surprising for you.

**Description:**

Extrapolation represents ......and was calculated ....

This map below shows the (EXTRAPOLTAION layer)..................
:::
:::

## MAPS

```{r echo=FALSE, warning=FALSE, message=FALSE}

#  SPECIES DATA

  # Pallete
    pal <- colorNumeric(palette = "viridis",domain = locations_can71$count)
    pal2 <- colorQuantile("Greens", values(BBWA_can71_2020$mean),
                          na.color = "transparent")
    pal3 <- colorQuantile("Blues", values(BBWA_can71_2020$cv),
                          na.color = "transparent")
    pal4 <- colorNumeric("Reds", values(BBWA_can71_2020$extrapolation),
                          na.color = "transparent")

  # Leaflet map
   training_data_map <- leaflet() %>%
    
  # Setting view Canada
   setView(lng = -82, lat = 50, zoom = 4)%>%
     
  # Adding background map
    addProviderTiles(
    "Esri.WorldImagery",'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')%>%
 
  # Adding BCR map
    addPolygons(data=bcr_boundary_wgs84,
                weight=1,
                fillColor = '0',
                color = "white",
                label=bcr_boundary_wgs84$subUnit,
                 group= "Regions"
                )%>%
  # Adding species data
    addCircleMarkers(data=terra::project(locations_can71, "epsg:4326"),
                     fillColor = ~pal(locations_can71$count),
                     weight = 0.5,
                     radius = 2, 
                     color = ~pal(locations_can71$count),
                     group="Species_data")%>%
     
  # Adding legend species data
    addLegend('bottomright', pal = pal, values = locations_can71$year,
            title = "Year", opacity = 1, group="Species_data")%>%
     
  # Adding raster PREDICTIONS
    addRasterImage(terra::project(BBWA_can71_2020$mean, "epsg:4326"),
                   colors=pal2,opacity=0.8,
                   group="Predictions")%>%
    
     addLegend(pal = pal2,
               values = values(terra::project(BBWA_can71_2020$mean, "epsg:4326")),
               title = "Predictions (Mean-quantiles)",
               position = "bottomright",
               group = "Predictions")%>%
     

  # Adding raster UNCERTAINTY
    addRasterImage(terra::project(BBWA_can71_2020$cv, "epsg:4326"),
                   colors=pal3, opacity=0.8, group="Uncertainty")%>%
    
    addLegend(pal = pal3, values = values(BBWA_can71_2020$cv),
               title = "Uncertainty(CV-Quantiles)",
               position = "bottomright",
               layerId = "Uncertainty",
              group = "Uncertainty")%>%
     
 # Adding raster EXTRAPOLATION
     addRasterImage(terra::project(BBWA_can71_2020$extrapolation, "epsg:4326"),
                    colors=pal4,opacity=0.8, group="Extrapolation")%>%
     
     addLegend(pal = pal4, values = values(BBWA_can71_2020$extrapolation),
                title = "Extrapolation",
                position = "bottomright",
                layerId = "Extrapolation",
               group = "Extrapolation")%>%
  

   # add measurement tool
    addMeasure(primaryLengthUnit = "kilometers",
               secondaryLengthUnit = 'miles',
               primaryAreaUnit = "hectares",
               secondaryAreaUnit="acres",
               position = 'topleft')%>%
  
 # Adding layer control
    addLayersControl(options = layersControlOptions(collapsed = T),
                       position ="topleft",
                       overlayGroups = c( "Regions",
                                          "Species_data",
                                          "Predictions",
                                          "Uncertainty",
                                          "Extrapolation"))%>%
                       hideGroup(c("Predictions", "Uncertainty", "Extrapolation"))
                     


```

```{r}
  training_data_map
```
